<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>DropTV Player - Auto Refresh</title>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.9"></script>
  <style>
    html, body {
      margin: 0; padding: 0;
      background: #000; color: #fff;
      height: 100%; display: flex;
      align-items: center; justify-content: center;
      flex-direction: column;
      font-family: sans-serif;
    }
    video {
      width: 90%;
      max-width: 1280px;
      border-radius: 8px;
      background: #111;
    }
    #status {
      margin-top: 10px;
      opacity: 0.7;
      font-size: 14px;
    }
  </style>
</head>
<body>

  <video id="video" controls autoplay muted playsinline></video>
  <div id="status">Iniciando player...</div>

  <script>
    const PLAY_URL = 'https://hls.fred1807.workers.dev'; // endpoint do seu Worker
    const REFRESH_INTERVAL = 60000; // 60 segundos
    const video = document.getElementById('video');
    const status = document.getElementById('status');

    let hls;
    let currentUrl = '';
    let refreshTimer;

    async function fetchStreamUrl() {
      try {
        const res = await fetch(PLAY_URL + '?_=' + Date.now()); // cache-buster
        const text = await res.text();
        if (!text.includes('.m3u8')) throw new Error('Resposta inválida');
        return text.trim();
      } catch (err) {
        console.error('Falha ao obter URL da stream:', err);
        return null;
      }
    }

    async function initPlayer() {
      const url = await fetchStreamUrl();
      if (!url) {
        status.textContent = 'Falha ao obter URL inicial';
        return;
      }
      currentUrl = url;
      status.textContent = 'Reproduzindo stream atual...';

      if (Hls.isSupported()) {
        hls = new Hls({
          liveSyncDuration: 5,
          maxBufferLength: 30,
          maxMaxBufferLength: 60,
          backBufferLength: 10,
        });

        hls.loadSource(currentUrl);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, () => video.play().catch(()=>{}));
        hls.on(Hls.Events.ERROR, async (event, data) => {
          console.warn('HLS error', data);
          if (data.fatal) {
            await reloadStream('Erro fatal');
          }
        });

      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // Safari nativo
        video.src = currentUrl;
        video.addEventListener('error', reloadStream);
        video.play();
      }

      // Atualização proativa a cada 60 s
      startRefreshLoop();
    }

    async function reloadStream(reason) {
      console.log('⟳ Recarregando stream:', reason);
      status.textContent = 'Atualizando stream... (' + reason + ')';
      const newUrl = await fetchStreamUrl();
      if (!newUrl) {
        console.warn('Nova URL não obtida, tentando novamente...');
        setTimeout(() => reloadStream('retry'), 5000);
        return;
      }

      // Troca suave (sem dar stop total)
      try {
        if (hls) {
          hls.swapAudioCodec(); // previne glitches de áudio
          hls.loadSource(newUrl);
          currentUrl = newUrl;
          status.textContent = 'Stream atualizado.';
          console.log('Nova URL carregada com sucesso.');
        } else {
          video.src = newUrl;
          video.play();
        }
      } catch (err) {
        console.error('Erro no reload suave:', err);
      }
    }

    function startRefreshLoop() {
      if (refreshTimer) clearInterval(refreshTimer);
      refreshTimer = setInterval(() => reloadStream('refreshInterval'), REFRESH_INTERVAL);
    }

    // Monitora fim da reprodução
    video.addEventListener('ended', () => reloadStream('end'));
    video.addEventListener('stalled', () => reloadStream('stalled'));
    video.addEventListener('suspend', () => reloadStream('suspend'));
    video.addEventListener('error', () => reloadStream('videoError'));

    initPlayer();
  </script>
</body>
</html>
